---
title: "Wrangling"
author: "Candelaria Retamal"
date: "2023-12-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(devtools)
```

```{r}
drinks_data <- read_csv(here::here("data/all_drinks.csv"))
```

We will start by checking the unique values contained in the columns that describe the ingredients

```{r}
# Get unique values in all ingredient columns
unique_ingredients <- unique(c(
  drinks_data$strIngredient1, drinks_data$strIngredient2, drinks_data$strIngredient3,
drinks_data$strIngredient4,
drinks_data$strIngredient5,
drinks_data$strIngredient6,
drinks_data$strIngredient7,
drinks_data$strIngredient8,
drinks_data$strIngredient9,
drinks_data$strIngredient10,
drinks_data$strIngredient11,
drinks_data$strIngredient12,
drinks_data$strIngredient13,
drinks_data$strIngredient14,
drinks_data$strIngredient15
))

# Define a function to replace specified ingredients
replace_ingredients <- function(x) {
  x <- tolower(x)
  x <- trimws(x)
  
  # Replace specified ingredients
  x <- ifelse(x %in% c("anis", "anise"), "anise", x)
  x <- ifelse(x %in% c("bailey's irish cream", "baileys irish cream"), "baileys irish cream", x)
  x <- ifelse(x %in% c("whipped cream", "whipped Cream", "whipping cream"), "whipped cream", x)
  x <- ifelse(x %in% c("whiskey", "whisky"), "whiskey", x)
  
  return(x)
}

# Apply the replacement function to all columns
drinks_data <- mutate_all(drinks_data, replace_ingredients)

# Convert to lowercase for standardization
unique_ingredients <- tolower(unique_ingredients)

# Remove leading and trailing whitespaces
unique_ingredients <- trimws(unique_ingredients)

# Get unique standardized values
unique_ingredients <- unique(unique_ingredients)

# Order the unique ingredient names alphabetically
unique_ingredients <- sort(unique_ingredients)

unique_ingredients <- sort(unique_ingredients)
#unique_ingredients
```

In the different steps we have checked the list of unique values. First, we solved the problems of words that differed in capitalization and number of spaces. Then we solved by hand words that belonged to a same root, but were written differently in the dataset. We are now sure that we have reduced the number of ingredients to the minimum possible.

```{r}
# Create a copy of the original dataset
drinks_data_combined <- drinks_data

# Combine corresponding Ingredient and Measure columns
for (i in 1:15) {
  ingredient_col <- paste0("strIngredient", i)
  measure_col <- paste0("strMeasure", i)
  
  new_col_name <- paste0("Ingredient_Measure_", i)
  
  drinks_data_combined[[new_col_name]] <- paste(drinks_data_combined[[ingredient_col]], drinks_data_combined[[measure_col]], sep = " ; ")
}

# Optionally, you can remove the individual ingredient and measurement columns
drinks_data_combined <- select(drinks_data_combined, -starts_with("strIngredient"), -starts_with("strMeasure"))

# Verify the changes
head(drinks_data_combined)
```

```{r}
# Create a copy of the original dataset
drinks_data_encoded <- drinks_data

# Get unique standardized values of ingredients
unique_ingredients <- c(
  drinks_data$strIngredient1, drinks_data$strIngredient2, drinks_data$strIngredient3,
  drinks_data$strIngredient4, drinks_data$strIngredient5, drinks_data$strIngredient6,
  drinks_data$strIngredient7, drinks_data$strIngredient8, drinks_data$strIngredient9,
  drinks_data$strIngredient10, drinks_data$strIngredient11, drinks_data$strIngredient12,
  drinks_data$strIngredient13, drinks_data$strIngredient14, drinks_data$strIngredient15
) %>%
  tolower() %>%
  trimws() %>%
  unique()

# Create one-hot encoded columns for each ingredient
for (ingredient in unique_ingredients) {
  column_name <- paste0("ingredient_", gsub(" ", "_", ingredient))
  drinks_data_encoded[column_name] <- as.integer(
    rowSums(sapply(1:15, function(i) grepl(ingredient, drinks_data[[paste0("strIngredient", i)]], ignore.case = TRUE))) > 0
  )
}

# Optionally, you can remove the individual ingredient columns
drinks_data_encoded <- select(drinks_data_encoded, -starts_with("strIngredient"))

# Verify the changes
head(drinks_data_encoded)

```

Create one column per ingredient and put the measurements instead of the binary 1 and 0. If it is a 1, replace for the actual measurement of the ingredient per drinking.

```{r}
for (row_index in 1:nrow(drinks_data_combined)) {
  # Iterate over columns Ingredients_Measures_X
  for (i in 1:15) {
    col_name <- paste("Ingredient_Measure_", i, sep = "")
    
    #Obtain entry of the current column
    entry <- as.character(drinks_data_combined[row_index, col_name])
    
    # Verify if entry is NA and of type chr
    if (!is.na(entry) && length(entry) > 0) {
      # Separate ingredient and measurement
      parts <- strsplit(entry, "; ", fixed = TRUE)[[1]]
      
      # Obtain ingredient and measurement
      ingredient <- parts[1]
      measure <- parts[2]
      
      # Value of the column that corresponds to ingredient and current row
      drinks_data_combined[row_index, ingredient] <- measure
    }
  }
}

# Verify result
head(drinks_data_combined)

```

Remove columns that have been wrangled using the binary approach. Also, remove those columns that do not contain enough or valuable information.

```{r}
# Eliminar columnas que contienen "Ingredient_Measure" en el nombre
columns_to_remove <- grep("Ingredient_Measure", names(drinks_data_combined))
drinks_data_combined <- drinks_data_combined[, -columns_to_remove]

columns_to_remove <- grep("...1", names(drinks_data_combined))
drinks_data_combined <- drinks_data_combined[, -columns_to_remove]

columns_to_remove <- grep("strIBA", names(drinks_data_combined))
drinks_data_combined <- drinks_data_combined[, -columns_to_remove]

columns_to_remove <- grep("dateModified", names(drinks_data_combined))
drinks_data_combined <- drinks_data_combined[, -columns_to_remove]

columns_to_remove <- grep("idDrink", names(drinks_data_combined))
drinks_data_combined <- drinks_data_combined[, -columns_to_remove]

columns_to_remove <- grep("strVideo", names(drinks_data_combined))
drinks_data_combined <- drinks_data_combined[, -columns_to_remove]

columns_to_remove <- grep("NA", names(drinks_data_combined))
drinks_data_combined <- drinks_data_combined[, -columns_to_remove]
head(drinks_data_combined)
```

Change the names of the columns, and rearrange the information correctly to make sure that the cleaning process is complete.

```{r}
# Rename the column
colnames(drinks_data_combined)[colnames(drinks_data_combined) == "strDrink"] <- "Name"
colnames(drinks_data_combined)[colnames(drinks_data_combined) == "strAlcoholic"] <- "Type"
colnames(drinks_data_combined)[colnames(drinks_data_combined) == "strCategory"] <- "Category"
colnames(drinks_data_combined)[colnames(drinks_data_combined) == "strDrinkThumb"] <- "Picture"
colnames(drinks_data_combined)[colnames(drinks_data_combined) == "strGlass"] <- "Glass"
colnames(drinks_data_combined)[colnames(drinks_data_combined) == "strInstructions"] <- "Recipe"
colnames(drinks_data_combined)[colnames(drinks_data_combined) == "151 proof rum "] <- "151 bacardi rum"
```

Eliminate the inconsistencies found in the dataset, on the section of the measurements.

```{r, warning=FALSE}
# Assuming your dataframe is called drinks_data_combined
drinks_data_combined <- mutate_all(drinks_data_combined, ~ifelse(. == "NA", NA, .))
# Replace "your_column_names" with the actual names of columns 7 to 310 in your dataframe
columns_to_modify <- colnames(drinks_data_combined)[7:310]

# Use mutate_at to apply the string replacement to the selected columns
drinks_data_combined <- mutate_at(drinks_data_combined, vars(columns_to_modify), funs(gsub("\\bbacardi\\b", "", .)))
#removing whitespace in column names
colnames(drinks_data_combined) <- colnames(drinks_data_combined) %>% str_trim()
```

The binary columns have been pasted at the end of the dataframe. A good identifier to separate them is that they contain the word ingredient in the name (you may use grepl).

```{r}
#dropping one NA in type and one NA in recipe
cocktails <- drinks_data_combined %>% 
  filter(!is.na(Type) & ! is.na(Recipe))
```

#Checking alcoholic drinks
```{r}
all_cols <- unique(colnames(cocktails)) %>% str_trim() %>% sort()

categorical_vars <- c("Name", "Type", "Category", "Picture", "Glass", "Recipe")

unique_ing <- setdiff(all_cols, categorical_vars)

alcohol_vec <- c("151 bacardi rum", "absinthe", "absolut citron", "absolut kurant", "absolut peppar", "absolut vodka", "advocaat", "ale", "amaretto", "anisette", "aperol", "apfelkorn", "apple brandy", "apple cider", "apple schnapps", "applejack", "apricot brandy", "aquavit", "añejo rum", "bacardi limon", "baileys irish cream", "banana liqueur", "beer", "benedictine", "black sambuca", "blackberry brandy", "blended whiskey", "blue curacao", "blueberry schnapps", "bourbon", "brandy", "butterscotch schnapps", "cachaca", "campari", "chambord raspberry liqueur", "champagne", "cherry brandy", "cherry heering", "cherry liqueur","chocolate liqueur", "cider", "coconut liqueur", "coconut rum", "coffee brandy", "coffee liqueur", "cognac", "cointreau", "corona", "cranberry vodka", "cream of coconut", "creme de banane", "creme de cacao", "creme de cassis", "creme de mure", "crown royal", "curacao", "dark creme de cacao", "dark rum","drambuie", "dry vermouth", "dubonnet rouge", "erin cream", "everclear", "firewater", "frangelico", "galliano", "gin", "godiva liqueur", "gold tequila", "goldschlager", "grain alcohol", "grand marnier", "green chartreuse", "green creme de menthe", "guinness stout", "hot damn", "irish cream", "irish whiskey", "jack daniels", "jim beam", "johnnie walker", "jägermeister", "kahlua", "kirschwasser", "kiwi liqueur", "lager", "lemon vodka", "light rum", "lillet blanc", "lime vodka", "malibu rum", "maraschino liqueur", "melon liqueur", "midori melon liqueur", "orange curacao", "ouzo", "peach brandy", "peach schnapps", "peach vodka", "peppermint schnapps", "peychaud bitters", "pisang ambon", "pisco", "port", "prosecco", "raspberry liqueur", "raspberry vodka", "red wine", "ricard", "rum", "rumple minze", "rye whiskey", "sambuca", "scotch", "sherry", "sloe gin", "southern comfort", "spiced rum", "st. germain", "strawberry liqueur", "strawberry schnapps", "sweet vermouth", "tennessee whiskey", "tequila", "tia maria", "triple sec", "vanilla vodka", "vermouth", "vodka", "whiskey", "white creme de menthe", "white rum", "wild turkey", "wine", "yellow chartreuse", "yukon jack")

side_ing_vec <- setdiff(unique_ing, alcohol_vec)
```

We have 8 cocktails that are marked as alcoholic but don't contain alcohol in the vector
```{r}
filtered_cocktails <- cocktails %>%
  mutate(sums = rowSums(!is.na(.[, alcohol_vec]))) %>% 
  select(sums, everything()) %>% 
  filter(sums !=0)
#467 of type alcoholic and 8 of optional alcohol
filtered_cocktails %>% 
  count(Type)
#--> 475 which contain alcohol
contain_alc <- filtered_cocktails %>% pull(Name)

#486 which are of either type --> 11 which are missing
are_alc <- cocktails %>% 
  filter(Type =="alcoholic" | Type == "optional alcohol")

# out of those 11, we had only 3 names which contained at least one ingredient
are_alc %>%
  filter(!Name %in% contain_alc) %>% 
  select(-c(Category, Picture, Glass, Recipe)) %>%
  pivot_longer(-c(Name, Type), names_to = "ingredient", values_to = "quantity", values_drop_na  = T)

alcohol_vec <- append(alcohol_vec, c("maui","peachtree schnapps","surge")) %>% sort()
```
Dropping cocktails which contain no ingredients, or those that don't make sense:
- black forest shake --> alcoholic but contains only ice
- egg-nog - classic cooked --> optional alcohol but without alcohol ingredient listed
- zoksel - alcoholic type but contains only coca-cola
```{r}
#filtering out 3 cocktails list above
cocktails <- cocktails %>% 
  filter(!Name %in% c("black forest shake", "egg-nog - classic cooked", "zoksel"))

#removing additional 7 cocktails which contain 0 ingredients
cocktails <- cocktails %>% 
  mutate(sums = rowSums(!is.na(.[, unique_ing]))) %>%
  filter(sums != 0) %>% 
  select(-sums)
```

#Creating rda files
```{r eval=FALSE}
# Assuming your dataframes are named drinks_data_combined and drinks_data_encoded
#selected_columns <- drinks_data_encoded %>% select(27:331)
#drinks_data_combined <- bind_cols(drinks_data_combined, selected_columns)
usethis::use_data(cocktails, overwrite = TRUE)
usethis::use_data(unique_ing)
usethis::use_data(alcohol_vec, overwrite = TRUE)
usethis::use_data(side_ing_vec)
```

